apiVersion: v1
kind: Service
metadata:
  name: kcp-front-proxy
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app.kubernetes.io/component: "front-proxy"
  {{- with .Values.kcpFrontProxy.service.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  type: {{ .Values.kcpFrontProxy.service.type }}
  ports:
    - protocol: TCP
      name: kcp-front-proxy
      port: 8443
      targetPort: 8443
  selector:
    {{- include "common.labels.selector" . | nindent 4 }}
    app.kubernetes.io/component: "front-proxy"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kcp-front-proxy
  labels:
    {{- include "common.labels" . | nindent 4 }}
    app.kubernetes.io/component: "front-proxy"
spec:
  replicas: 1
  selector:
    matchLabels:
      {{- include "common.labels.selector" . | nindent 6 }}
      app.kubernetes.io/component: "front-proxy"
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        {{- include "common.labels" . | nindent 8 }}
        app.kubernetes.io/component: "front-proxy"
    spec:
      {{- with .Values.kcpFrontProxy.securityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.kcpFrontProxy.hostAliases.enabled }}
      hostAliases:
        {{- toYaml .Values.kcpFrontProxy.hostAliases.values | nindent 6 }}
      {{- end }}
      containers:
      - name: kcp-front-proxy
        image: {{ .Values.kcpFrontProxy.image }}:{{ .Values.kcpFrontProxy.tag }}
        imagePullPolicy: {{ .Values.kcpFrontProxy.pullPolicy }}
        ports:
        - containerPort: 8443
        command: ["/kcp-front-proxy"]
        args:
        - --secure-port=8443
        - --root-kubeconfig=/etc/kcp-front-proxy/kubeconfig/root-shard.kubeconfig
        {{- if .Values.kcpFrontProxy.shardsKubeConfigFlag }}
        - --shards-kubeconfig=/etc/kcp-front-proxy/kubeconfig/root-shard.kubeconfig
        {{- end }}
        - --tls-private-key-file=/etc/kcp-front-proxy/tls/tls.key
        - --tls-cert-file=/etc/kcp-front-proxy/tls/tls.crt
        - --client-ca-file=/etc/kcp-front-proxy/client-ca/tls.crt
        - --service-account-key-file=/etc/kcp/tls/service-account/tls.key
        - --mapping-file=/etc/kcp-front-proxy/config/path-mapping.yaml
        - --v={{ .Values.kcpFrontProxy.v }}
        - --logging-format=json
        {{- if .Values.kcpFrontProxy.profiling.enabled }}
        - --profiler-address=localhost:{{- .Values.kcpFrontProxy.profiling.port -}}
        {{- end }}
        {{- if .Values.oidc.enabled }}
        - --oidc-issuer-url={{ .Values.oidc.issuerUrl }}
        - --oidc-client-id={{ .Values.oidc.clientId }}
        - --oidc-groups-claim={{ .Values.oidc.groupClaim }}
        - --oidc-username-claim={{ .Values.oidc.usernameClaim }}
        - '--oidc-username-prefix={{ .Values.oidc.usernamePrefix }}'
        - '--oidc-groups-prefix={{ .Values.oidc.groupsPrefix }}'
        {{- if .Values.oidc.caSecretName }}
        - --oidc-ca-file=/etc/kcp/tls/oidc/ca.crt
        {{- end }}
        {{- end }}
        {{- if .Values.kcp.tokenAuth.enabled }}
        - --token-auth-file=/etc/kcp/token-auth/{{ .Values.kcp.tokenAuth.fileName }}
        {{- end }}
        livenessProbe:
          failureThreshold: 3
          httpGet:
            path: livez
            port: 8443
            scheme: HTTPS
          initialDelaySeconds: 45
          periodSeconds: 10
          successThreshold: 1
          timeoutSeconds: 10
        readinessProbe:
          failureThreshold: 3
          httpGet:
            path: readyz
            port: 8443
            scheme: HTTPS
        {{- with .Values.kcpFrontProxy.resources }}
        resources:
          {{- toYaml . | nindent 10 }}
        {{- end }}
        volumeMounts:
        - name: kcp-front-proxy-cert
          mountPath: /etc/kcp-front-proxy/tls
        - name: kcp-front-proxy-config
          mountPath: /etc/kcp-front-proxy/config
        - name: client-cert-for-kubeconfig
          mountPath: /etc/kcp-front-proxy/client-cert-for-kubeconfig
        - name: proxy-kcp-kubeconfig
          mountPath: /etc/kcp-front-proxy/kubeconfig
        - name: kcp-client-ca
          mountPath: /etc/kcp-front-proxy/client-ca
        - name: kcp
          mountPath: /etc/kcp/tls/server
        - name: kcp-front-proxy-kcp-client-cert
          mountPath: /etc/kcp-front-proxy/requestheader-client/tls/kcp
        - name: kcp-service-account-cert
          mountPath: /etc/kcp/tls/service-account
        {{- if .Values.kcp.tokenAuth.enabled }}
        - name: kcp-token-auth-file
          mountPath: /etc/kcp/token-auth
        {{- end}}
        {{- if .Values.oidc.enabled }}
        {{- if .Values.oidc.caSecretName }}
        - name: oidc-ca
          mountPath: /etc/kcp/tls/oidc
        {{- end }}
        {{- end }}
{{- with .Values.kcpFrontProxy.extraVolumeMounts }}
{{ . | toYaml | indent 8 }}
{{- end }}
      volumes:
      - name: kcp-front-proxy-cert
        secret:
          secretName: kcp-front-proxy-cert
      - name: kcp-client-ca
        secret:
          secretName: kcp-client-ca
          items:
            - key: tls.crt
              path: tls.crt
      - name: kcp
        secret:
          secretName: kcp-cert
          items:
            - key: ca.crt
              path: ca.crt
      - name: client-cert-for-kubeconfig
        secret:
          secretName: client-cert-for-kubeconfig
          items:
            - key: tls.crt
              path: tls.crt
            - key: tls.key
              path: tls.key
      - name: kcp-front-proxy-kcp-client-cert
        secret:
          secretName: kcp-front-proxy-kcp-client-cert
          items:
            - key: tls.crt
              path: tls.crt
            - key: tls.key
              path: tls.key
      - name: kcp-service-account-cert
        secret:
          secretName: kcp-service-account-cert
          items:
            - key: tls.key
              path: tls.key
      - name: proxy-kcp-kubeconfig
        secret:
          secretName: proxy-kcp-kubeconfig
          items:
            - key: kubeconfig
              path: root-shard.kubeconfig
      - name: kcp-front-proxy-config
        configMap:
          name: kcp-front-proxy-config
          items:
            - key: "path-mapping.yaml"
              path: "path-mapping.yaml"
      {{- if .Values.oidc.enabled }}
      {{- if .Values.oidc.caSecretName }}
      - name: oidc-ca
        secret:
          secretName: {{.Values.oidc.caSecretName }}
      {{- end }}
      {{- end }}
      {{- if .Values.kcp.tokenAuth.enabled }}
      - name: kcp-token-auth-file
        secret:
          secretName: kcp-token-auth-file
      {{- end }}
{{- with .Values.kcpFrontProxy.extraVolumes }}
{{ . | toYaml | indent 6 }}
{{- end }}
